name: Governance Validation

on:
  pull_request:
    paths:
      - ".parac/**"
      - ".claude/**"
      - ".github/copilot-instructions.md"
      - ".parac/integrations/ide/**"
  push:
    branches:
      - main
      - develop
    paths:
      - ".parac/**"
      - ".claude/**"
      - ".github/copilot-instructions.md"

permissions:
  contents: read

jobs:
  validate-governance:
    name: Validate Governance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync

      - name: Validate AI Instructions
        run: uv run paracle validate ai-instructions

      - name: Validate Governance Structure
        run: uv run paracle validate governance

      - name: Validate Roadmap Consistency
        run: uv run paracle validate roadmap

      - name: Check YAML Syntax
        run: |
          find .parac -name "*.yaml" -o -name "*.yml" | while read -r file; do
            echo "Validating $file"
            python -c "import yaml; yaml.safe_load(open('$file', encoding='utf-8'))"
          done

      - name: Verify ADR Numbering
        run: uv run python scripts/check_adr_numbering.py
        continue-on-error: true # Don't fail if script doesn't exist yet

  validate-structure:
    name: Validate .parac Structure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required files exist
        run: |
          required_files=(
            ".parac/GOVERNANCE.md"
            ".parac/PRE_FLIGHT_CHECKLIST.md"
            ".parac/manifest.yaml"
            ".parac/project.yaml"
            ".parac/roadmap/roadmap.yaml"
            ".parac/roadmap/decisions.md"
            ".parac/memory/context/current_state.yaml"
            ".parac/memory/context/open_questions.md"
            ".parac/agents/manifest.yaml"
          )

          missing=()
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing required file: $file"
              missing+=("$file")
            else
              echo "✅ Found: $file"
            fi
          done

          if [ ${#missing[@]} -gt 0 ]; then
            echo ""
            echo "Error: Missing ${#missing[@]} required governance files"
            exit 1
          fi

      - name: Verify pre-flight checklist in IDE configs
        run: |
          ide_files=(
            ".cursorrules"
            ".parac/integrations/ide/.clinerules"
            ".parac/integrations/ide/.windsurfrules"
            ".parac/integrations/ide/CLAUDE.md"
            ".github/copilot-instructions.md"
          )

          required_sections=(
            "MANDATORY PRE-FLIGHT CHECKLIST"
            "PRE_FLIGHT_CHECKLIST.md"
            "VALIDATE"
            "If Task NOT in Roadmap"
          )

          failed=()
          for file in "${ide_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "⚠️  File not found: $file"
              continue
            fi

            echo "Checking $file..."
            missing_sections=()
            for section in "${required_sections[@]}"; do
              if ! grep -q "$section" "$file"; then
                missing_sections+=("$section")
              fi
            done

            if [ ${#missing_sections[@]} -gt 0 ]; then
              echo "❌ $file missing sections: ${missing_sections[*]}"
              failed+=("$file")
            else
              echo "✅ $file has all required sections"
            fi
          done

          if [ ${#failed[@]} -gt 0 ]; then
            echo ""
            echo "Error: ${#failed[@]} IDE config files missing pre-flight checklist sections"
            exit 1
          fi

  test-governance:
    name: Run Governance Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync

      - name: Run governance tests
        run: uv run pytest tests/governance/ -v
        continue-on-error: true # Don't fail if tests don't exist yet

